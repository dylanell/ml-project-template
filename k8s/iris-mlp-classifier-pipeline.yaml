apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: iris-mlp-classifier-pipeline-
spec:
  entrypoint: pipeline
  templates:
    - name: preprocess
      container:
        image: preprocessing-job:latest
        imagePullPolicy: Never
        command: ["uv", "run", "python", "scripts/preprocess_iris_dataset.py"]
        args: ["--config", "configs/iris_mlp_classifier.json"]
        envFrom:
          - secretRef:
              name: s3-credentials
        env:
          - name: PYTHONUNBUFFERED
            value: "1"
          - name: S3_ENDPOINT_URL
            value: "http://host.docker.internal:7000"
        volumeMounts:
          - name: configs
            mountPath: /app/configs
            readOnly: true
      volumes:
        - name: configs
          configMap:
            name: training-configs

    - name: train
      container:
        image: training-job:latest
        imagePullPolicy: Never
        command: ["uv", "run", "python", "scripts/train_iris_classifier.py"]
        args: ["--config", "configs/iris_mlp_classifier.json"]
        envFrom:
          - secretRef:
              name: s3-credentials
        env:
          - name: PYTHONUNBUFFERED
            value: "1"
          - name: S3_ENDPOINT_URL
            value: "http://host.docker.internal:7000"
          - name: MLFLOW_TRACKING_URI
            value: "http://host.docker.internal:5000"
          - name: MLFLOW_S3_ENDPOINT_URL
            value: "http://host.docker.internal:7000"
        volumeMounts:
          - name: configs
            mountPath: /app/configs
            readOnly: true
      volumes:
        - name: configs
          configMap:
            name: training-configs

    - name: pipeline
      dag:
        tasks:
          - name: preprocess
            template: preprocess
          - name: train
            template: train
            dependencies: [preprocess]
